apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: collect-tmb-data-template
spec:
  templates:
    - name: collect-tmb-data
      inputs:
        parameters:
          - name: run-id
          - name: sample-id
          - name: duckdb-file
          - name: target-bed-file
          - name: af-lower-threshold
            value: "0.05"
          - name: af-upper-threshold
            value: "0.95"
          - name: output-dir
          # Common variant filtering parameters
          - name: filter-common-variants
            value: "true"
          - name: gnomad-vcf
            value: ""
          - name: turkish-variome-vcf
            value: ""
          - name: common-af-threshold
            value: "0.01"
          # Multihit gene filtering parameters
          - name: filter-multihit
            value: "true"
          - name: multihit-method
            value: "poisson"
          # Oncogenic tier filtering parameters
          - name: filter-oncogenic
            value: "true"
          - name: oncogenic-tiers
            value: "I,II"
          # DETS filtering parameters
          - name: filter-dets
            value: "true"
          - name: dets-threshold
            value: "2.5"
      volumes:
        - name: duckdb-file
          hostPath:
            path: "{{inputs.parameters.duckdb-file}}"
            type: File
        - name: target-bed-file
          hostPath:
            path: "{{inputs.parameters.target-bed-file}}"
            type: File
        - name: output-dir
          hostPath:
            path: "{{inputs.parameters.output-dir}}"
            type: DirectoryOrCreate
        - name: gnomad-vcf-dir
          hostPath:
            path: "{{=sprig.osDir(inputs.parameters['gnomad-vcf'])}}"
            type: Directory
        - name: turkish-variome-vcf-dir
          hostPath:
            path: "{{=sprig.osDir(inputs.parameters['turkish-variome-vcf'])}}"
            type: Directory
      script:
        name: tmb-calculator
        image: bergun/gennext-tmb-calc:0.3.0
        workingDir: /mnt/input
        volumeMounts:
          - name: duckdb-file
            mountPath: /mnt/input/{{=sprig.osBase(inputs.parameters['duckdb-file'])}}
            readOnly: true
          - name: target-bed-file
            mountPath: /mnt/input/{{=sprig.osBase(inputs.parameters['target-bed-file'])}}
            readOnly: true
          - name: output-dir
            mountPath: /mnt/output
          - name: gnomad-vcf-dir
            mountPath: /mnt/gnomad
            readOnly: true
          - name: turkish-variome-vcf-dir
            mountPath: /mnt/turkish
            readOnly: true
        command: [/bin/bash]
        source: |
          # Build base TMB calculation command
          CMD="python /app/calculate_tmb.py \
            --duckdb \"/mnt/input/{{=sprig.osBase(inputs.parameters['duckdb-file'])}}\" \
            --target-bed \"/mnt/input/{{=sprig.osBase(inputs.parameters['target-bed-file'])}}\" \
            --cds-bed \"/app/data/gencode_v48_canonical_cds.bed\" \
            --af-lower-threshold \"{{inputs.parameters.af-lower-threshold}}\" \
            --af-upper-threshold \"{{inputs.parameters.af-upper-threshold}}\" \
            --output-dir \"/mnt/output/\" \
            --api-endpoint \"http://gennext-backend.gennext-dev.svc.cluster.local:3030/api/v0/runs/{{inputs.parameters.run-id}}/somatic\" \
            --api-token \"$GENNEXT_CLUSTER_TOKEN\" \
            --run-id \"{{inputs.parameters.run-id}}\" \
            --sample-id \"{{inputs.parameters.sample-id}}\""

          # Add oncogenic tier filtering if enabled
          if [ "{{inputs.parameters.filter-oncogenic}}" = "true" ]; then
            CMD="$CMD --filter-oncogenic --oncogenic-tiers {{inputs.parameters.oncogenic-tiers}}"
          fi

          # Add common variant filtering if enabled
          if [ "{{inputs.parameters.filter-common-variants}}" = "true" ]; then
            CMD="$CMD --filter-common-variants"
            if [ -n "{{inputs.parameters.gnomad-vcf}}" ]; then
              CMD="$CMD --common-vcf /mnt/gnomad/{{=sprig.osBase(inputs.parameters['gnomad-vcf'])}}:AF"
            fi
            if [ -n "{{inputs.parameters.turkish-variome-vcf}}" ]; then
              CMD="$CMD --common-vcf /mnt/turkish/{{=sprig.osBase(inputs.parameters['turkish-variome-vcf'])}}:TR_AF"
            fi
            CMD="$CMD --common-af-threshold {{inputs.parameters.common-af-threshold}}"
          fi

          # Add multihit gene filtering if enabled
          if [ "{{inputs.parameters.filter-multihit}}" = "true" ]; then
            CMD="$CMD --filter-multihit --multihit-method {{inputs.parameters.multihit-method}}"
          fi

          # Add DETS filtering if enabled
          if [ "{{inputs.parameters.filter-dets}}" = "true" ]; then
            CMD="$CMD --filter-dets --dets-threshold {{inputs.parameters.dets-threshold}}"
          fi

          # Add verbose flag and run
          CMD="$CMD --verbose"
          echo "Running: $CMD"
          eval $CMD
        env:
          - name: GENNEXT_CLUSTER_TOKEN
            valueFrom:
              secretKeyRef:
                name: gennext-cluster-secrets
                key: gennext_cluster_token
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
    - name: collect-tmb-data-on-node
      nodeSelector:
        kubernetes.io/hostname: "{{inputs.parameters.node-name}}"
      inputs:
        parameters:
          - name: run-id
          - name: sample-id
          - name: duckdb-file
          - name: target-bed-file
          - name: af-lower-threshold
            value: "0.05"
          - name: af-upper-threshold
            value: "0.95"
          - name: output-dir
          - name: node-name
          # Common variant filtering parameters
          - name: filter-common-variants
            value: "true"
          - name: gnomad-vcf
            value: ""
          - name: turkish-variome-vcf
            value: ""
          - name: common-af-threshold
            value: "0.01"
          # Multihit gene filtering parameters
          - name: filter-multihit
            value: "true"
          - name: multihit-method
            value: "poisson"
          # Oncogenic tier filtering parameters
          - name: filter-oncogenic
            value: "true"
          - name: oncogenic-tiers
            value: "I,II"
          # DETS filtering parameters
          - name: filter-dets
            value: "true"
          - name: dets-threshold
            value: "2.5"
      volumes:
        - name: duckdb-file
          hostPath:
            path: "{{inputs.parameters.duckdb-file}}"
            type: File
        - name: target-bed-file
          hostPath:
            path: "{{inputs.parameters.target-bed-file}}"
            type: File
        - name: output-dir
          hostPath:
            path: "{{inputs.parameters.output-dir}}"
            type: DirectoryOrCreate
        - name: gnomad-vcf-dir
          hostPath:
            path: "{{=sprig.osDir(inputs.parameters['gnomad-vcf'])}}"
            type: Directory
        - name: turkish-variome-vcf-dir
          hostPath:
            path: "{{=sprig.osDir(inputs.parameters['turkish-variome-vcf'])}}"
            type: Directory
      script:
        name: tmb-calculator
        image: bergun/gennext-tmb-calc:0.3.0
        workingDir: /mnt/input
        volumeMounts:
          - name: duckdb-file
            mountPath: /mnt/input/{{=sprig.osBase(inputs.parameters['duckdb-file'])}}
            readOnly: true
          - name: target-bed-file
            mountPath: /mnt/input/{{=sprig.osBase(inputs.parameters['target-bed-file'])}}
            readOnly: true
          - name: output-dir
            mountPath: /mnt/output
          - name: gnomad-vcf-dir
            mountPath: /mnt/gnomad
            readOnly: true
          - name: turkish-variome-vcf-dir
            mountPath: /mnt/turkish
            readOnly: true
        command: [/bin/bash]
        source: |
          # Build base TMB calculation command
          CMD="python /app/calculate_tmb.py \
            --duckdb \"/mnt/input/{{=sprig.osBase(inputs.parameters['duckdb-file'])}}\" \
            --target-bed \"/mnt/input/{{=sprig.osBase(inputs.parameters['target-bed-file'])}}\" \
            --cds-bed \"/app/data/gencode_v48_canonical_cds.bed\" \
            --af-lower-threshold \"{{inputs.parameters.af-lower-threshold}}\" \
            --af-upper-threshold \"{{inputs.parameters.af-upper-threshold}}\" \
            --output-dir \"/mnt/output/\" \
            --api-endpoint \"http://gennext-backend.gennext-dev.svc.cluster.local:3030/api/v0/runs/{{inputs.parameters.run-id}}/somatic\" \
            --api-token \"$GENNEXT_CLUSTER_TOKEN\" \
            --run-id \"{{inputs.parameters.run-id}}\" \
            --sample-id \"{{inputs.parameters.sample-id}}\""

          # Add oncogenic tier filtering if enabled
          if [ "{{inputs.parameters.filter-oncogenic}}" = "true" ]; then
            CMD="$CMD --filter-oncogenic --oncogenic-tiers {{inputs.parameters.oncogenic-tiers}}"
          fi

          # Add common variant filtering if enabled
          if [ "{{inputs.parameters.filter-common-variants}}" = "true" ]; then
            CMD="$CMD --filter-common-variants"
            if [ -n "{{inputs.parameters.gnomad-vcf}}" ]; then
              CMD="$CMD --common-vcf /mnt/gnomad/{{=sprig.osBase(inputs.parameters['gnomad-vcf'])}}:AF"
            fi
            if [ -n "{{inputs.parameters.turkish-variome-vcf}}" ]; then
              CMD="$CMD --common-vcf /mnt/turkish/{{=sprig.osBase(inputs.parameters['turkish-variome-vcf'])}}:TR_AF"
            fi
            CMD="$CMD --common-af-threshold {{inputs.parameters.common-af-threshold}}"
          fi

          # Add multihit gene filtering if enabled
          if [ "{{inputs.parameters.filter-multihit}}" = "true" ]; then
            CMD="$CMD --filter-multihit --multihit-method {{inputs.parameters.multihit-method}}"
          fi

          # Add DETS filtering if enabled
          if [ "{{inputs.parameters.filter-dets}}" = "true" ]; then
            CMD="$CMD --filter-dets --dets-threshold {{inputs.parameters.dets-threshold}}"
          fi

          # Add verbose flag and run
          CMD="$CMD --verbose"
          echo "Running: $CMD"
          eval $CMD
        env:
          - name: GENNEXT_CLUSTER_TOKEN
            valueFrom:
              secretKeyRef:
                name: gennext-cluster-secrets
                key: gennext_cluster_token
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
    # Template for using custom CDS bed file
    - name: collect-tmb-data-custom-cds
      inputs:
        parameters:
          - name: run-id
          - name: sample-id
          - name: duckdb-file
          - name: target-bed-file
          - name: cds-bed-file
          - name: af-lower-threshold
            value: "0.05"
          - name: af-upper-threshold
            value: "0.95"
          - name: output-dir
          # Common variant filtering parameters
          - name: filter-common-variants
            value: "true"
          - name: gnomad-vcf
            value: ""
          - name: turkish-variome-vcf
            value: ""
          - name: common-af-threshold
            value: "0.01"
          # Multihit gene filtering parameters
          - name: filter-multihit
            value: "true"
          - name: multihit-method
            value: "poisson"
          # Oncogenic tier filtering parameters
          - name: filter-oncogenic
            value: "true"
          - name: oncogenic-tiers
            value: "I,II"
          # DETS filtering parameters
          - name: filter-dets
            value: "true"
          - name: dets-threshold
            value: "2.5"
      volumes:
        - name: duckdb-file
          hostPath:
            path: "{{inputs.parameters.duckdb-file}}"
            type: File
        - name: target-bed-file
          hostPath:
            path: "{{inputs.parameters.target-bed-file}}"
            type: File
        - name: cds-bed-file
          hostPath:
            path: "{{inputs.parameters.cds-bed-file}}"
            type: File
        - name: output-dir
          hostPath:
            path: "{{inputs.parameters.output-dir}}"
            type: DirectoryOrCreate
        - name: gnomad-vcf-dir
          hostPath:
            path: "{{=sprig.osDir(inputs.parameters['gnomad-vcf'])}}"
            type: Directory
        - name: turkish-variome-vcf-dir
          hostPath:
            path: "{{=sprig.osDir(inputs.parameters['turkish-variome-vcf'])}}"
            type: Directory
      script:
        name: tmb-calculator
        image: bergun/gennext-tmb-calc:0.3.0
        workingDir: /mnt/input
        volumeMounts:
          - name: duckdb-file
            mountPath: /mnt/input/{{=sprig.osBase(inputs.parameters['duckdb-file'])}}
            readOnly: true
          - name: target-bed-file
            mountPath: /mnt/input/{{=sprig.osBase(inputs.parameters['target-bed-file'])}}
            readOnly: true
          - name: cds-bed-file
            mountPath: /mnt/input/{{=sprig.osBase(inputs.parameters['cds-bed-file'])}}
            readOnly: true
          - name: output-dir
            mountPath: /mnt/output
          - name: gnomad-vcf-dir
            mountPath: /mnt/gnomad
            readOnly: true
          - name: turkish-variome-vcf-dir
            mountPath: /mnt/turkish
            readOnly: true
        command: [/bin/bash]
        source: |
          # Build base TMB calculation command
          CMD="python /app/calculate_tmb.py \
            --duckdb \"/mnt/input/{{=sprig.osBase(inputs.parameters['duckdb-file'])}}\" \
            --target-bed \"/mnt/input/{{=sprig.osBase(inputs.parameters['target-bed-file'])}}\" \
            --cds-bed \"/mnt/input/{{=sprig.osBase(inputs.parameters['cds-bed-file'])}}\" \
            --af-lower-threshold \"{{inputs.parameters.af-lower-threshold}}\" \
            --af-upper-threshold \"{{inputs.parameters.af-upper-threshold}}\" \
            --output-dir \"/mnt/output/\" \
            --api-endpoint \"http://gennext-backend.gennext-dev.svc.cluster.local:3030/api/v0/runs/{{inputs.parameters.run-id}}/somatic\" \
            --api-token \"$GENNEXT_CLUSTER_TOKEN\" \
            --run-id \"{{inputs.parameters.run-id}}\" \
            --sample-id \"{{inputs.parameters.sample-id}}\""

          # Add oncogenic tier filtering if enabled
          if [ "{{inputs.parameters.filter-oncogenic}}" = "true" ]; then
            CMD="$CMD --filter-oncogenic --oncogenic-tiers {{inputs.parameters.oncogenic-tiers}}"
          fi

          # Add common variant filtering if enabled
          if [ "{{inputs.parameters.filter-common-variants}}" = "true" ]; then
            CMD="$CMD --filter-common-variants"
            if [ -n "{{inputs.parameters.gnomad-vcf}}" ]; then
              CMD="$CMD --common-vcf /mnt/gnomad/{{=sprig.osBase(inputs.parameters['gnomad-vcf'])}}:AF"
            fi
            if [ -n "{{inputs.parameters.turkish-variome-vcf}}" ]; then
              CMD="$CMD --common-vcf /mnt/turkish/{{=sprig.osBase(inputs.parameters['turkish-variome-vcf'])}}:TR_AF"
            fi
            CMD="$CMD --common-af-threshold {{inputs.parameters.common-af-threshold}}"
          fi

          # Add multihit gene filtering if enabled
          if [ "{{inputs.parameters.filter-multihit}}" = "true" ]; then
            CMD="$CMD --filter-multihit --multihit-method {{inputs.parameters.multihit-method}}"
          fi

          # Add DETS filtering if enabled
          if [ "{{inputs.parameters.filter-dets}}" = "true" ]; then
            CMD="$CMD --filter-dets --dets-threshold {{inputs.parameters.dets-threshold}}"
          fi

          # Add verbose flag and run
          CMD="$CMD --verbose"
          echo "Running: $CMD"
          eval $CMD
        env:
          - name: GENNEXT_CLUSTER_TOKEN
            valueFrom:
              secretKeyRef:
                name: gennext-cluster-secrets
                key: gennext_cluster_token
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
